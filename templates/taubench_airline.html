{% extends "base.html" %}

{% block title %}HAL: TAU-bench Airline{% endblock %}

{% block description %}TAU-bench Airline evaluates AI agents on real-world airline domain tasks.{% endblock %}

{% block nav_title %}
<span class="text-2xl ml-4">/ TAU-bench Airline</span>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="bg-gradient-to-b from-blue-50 to-white">
    <div class="mx-auto max-w-[1500]px px-8 py-16">
        <h1 class="text-4xl font-bold mb-4">TAU-bench Airline</h1>
        <p class="text-xl text-gray-600 mb-8 max-w-3xl">
            TAU-bench is a benchmark for Tool-Agent-User Interaction in Real-World Domains. TAU-bench Airline evaluates AI agents on tasks in the airline domain, such as changing filghts or finding new flights.
        </p>
        <p class="text-sm text-gray-500 mb-8 max-w-3xl">
            Paper: <a href="https://arxiv.org/abs/2406.12045" class="text-blue-600 hover:text-blue-800">
                τ-bench: A Benchmark for Tool-Agent-User Interaction in Real-World Domains (Yao et al., 2024)</a>
        </p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="text-3xl font-bold text-blue-600 mb-2">50</div>
                <div class="text-gray-600">Tasks in Public Test Set</div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md">
                {% set unique_scaffolds = [] %}
                {% set unique_models = [] %}
                {% for row in leaderboard %}
                    {% if row['Agent Name'] not in unique_scaffolds %}
                        {% set _ = unique_scaffolds.append(row['Agent Name']) %}
                    {% endif %}
                    {% for model in row['Models'].split(',') %}
                        {% set model_name = model.strip() %}
                        {% if model_name not in unique_models %}
                            {% set _ = unique_models.append(model_name) %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
                <div class="text-3xl font-bold text-blue-600 mb-2">{{ leaderboard|length }}</div>
                <div class="text-gray-600">Evaluations ({{ unique_scaffolds|length }} scaffold{{ 's' if unique_scaffolds|length != 1 else '' }}, {{ unique_models|length }} model{{ 's' if unique_models|length != 1 else '' }})</div>
            </div>
        </div>
    </div>
</div>

<div class="mx-auto max-w-[1500]px px-8 py-6">
    <!-- Results Section -->
    <div class="mb-16">
        <!-- Leaderboard Table -->
        <div class="bg-white rounded-xl shadow-md p-8 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-3xl font-semibold">TAU-bench Airline Leaderboard</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Scaffold</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider group relative">
                                <span class="cursor-help inline-flex items-center">
                                    Primary Model
                                    <svg class="w-4 h-4 ml-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </span>
                                <div class="invisible group-hover:visible absolute z-50 w-64 p-4 text-sm bg-white rounded-lg shadow-lg border border-gray-200 -translate-x-1/2 left-1/2 top-full mt-1">
                                    <div class="absolute w-4 h-4 bg-white transform rotate-45 -translate-x-1/2 left-1/2 -top-2 border-t border-l border-gray-200"></div>
                                    <div class="flex items-center mb-2">
                                        <svg class="w-5 h-5 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 4.5v1.5m3-1.5v1.5m3-1.5v1.5M4.5 9h1.5m-1.5 3h1.5m-1.5 3h1.5M18 9h1.5m-1.5 3h1.5m-1.5 3h1.5M9 18v1.5m3-1.5v1.5m3-1.5v1.5M7.5 6h9A1.5 1.5 0 0118 7.5v9a1.5 1.5 0 01-1.5 1.5h-9A1.5 1.5 0 016 16.5v-9A1.5 1.5 0 017.5 6z"/>
                                        </svg>
                                        <span class="font-medium text-gray-900">Primary Model</span>
                                    </div>
                                    <p class="text-gray-600 leading-relaxed">This is the primary model used by the agent. In some cases, an embedding model is used for RAG, or a secondary model like GPT-4o for image processing.
                                        <span class="font-semibold">Note:</span> For non-OpenAI reasoning models, the reasoning token budget is set at 1,024 (low), 2,048 (medium), and 4,096 (high).
                                    </p>
                                </div>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider group relative">
                                <span class="cursor-help inline-flex items-center">
                                    Verified
                                    <svg class="w-4 h-4 ml-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </span>
                                <div class="invisible group-hover:visible absolute z-50 w-64 p-4 text-sm bg-white rounded-lg shadow-lg border border-gray-200 -translate-x-1/2 left-1/2 top-full mt-1">
                                    <div class="absolute w-4 h-4 bg-white transform rotate-45 -translate-x-1/2 left-1/2 -top-2 border-t border-l border-gray-200"></div>
                                    <div class="flex items-center mb-2">
                                        <svg class="w-5 h-5 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span class="font-medium text-gray-900">Verified Results</span>
                                    </div>
                                    <p class="text-gray-600 leading-relaxed">Results have been reproduced by the HAL team</p>
                                </div>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider group relative">
                                <span class="cursor-help inline-flex items-center">
                                    Accuracy
                                    <svg class="w-4 h-4 ml-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </span>
                                <div class="invisible group-hover:visible absolute z-50 w-64 p-4 text-sm bg-white rounded-lg shadow-lg border border-gray-200 -translate-x-1/2 left-1/2 top-full mt-1">
                                    <div class="absolute w-4 h-4 bg-white transform rotate-45 -translate-x-1/2 left-1/2 -top-2 border-t border-l border-gray-200"></div>
                                    <div class="flex items-center mb-2">
                                        <svg class="w-5 h-5 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                        </svg>
                                        <span class="font-medium text-gray-900">Accuracy</span>
                                    </div>
                                    <p class="text-gray-600 leading-relaxed">Confidence intervals show the min-max values across runs for those agents where multiple runs are available</p>
                                </div>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider group relative">
                                <span class="cursor-help inline-flex items-center">
                                    Cost (USD)
                                    <svg class="w-4 h-4 ml-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </span>
                                <div class="invisible group-hover:visible absolute z-50 w-64 p-4 text-sm bg-white rounded-lg shadow-lg border border-gray-200 -translate-x-1/2 left-1/2 top-full mt-1">
                                    <div class="absolute w-4 h-4 bg-white transform rotate-45 -translate-x-1/2 left-1/2 -top-2 border-t border-l border-gray-200"></div>
                                    <div class="flex items-center mb-2">
                                        <svg class="w-5 h-5 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span class="font-medium text-gray-900">Total Cost</span>
                                    </div>
                                    <p class="text-gray-600 leading-relaxed">Total API cost for running the agent on all tasks. Confidence intervals show the min-max values across runs for those agents where multiple runs are available</p>
                                </div>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider group relative">
                                <span class="cursor-help inline-flex items-center">
                                    Runs
                                    <svg class="w-4 h-4 ml-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </span>
                                <div class="invisible group-hover:visible absolute z-50 w-64 p-4 text-sm bg-white rounded-lg shadow-lg border border-gray-200 -translate-x-1/2 left-1/2 top-full mt-1">
                                    <div class="absolute w-4 h-4 bg-white transform rotate-45 -translate-x-1/2 left-1/2 -top-2 border-t border-l border-gray-200"></div>
                                    <div class="flex items-center mb-2">
                                        <svg class="w-5 h-5 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        <span class="font-medium text-gray-900">Number of Runs</span>
                                    </div>
                                    <p class="text-gray-600 leading-relaxed">The number of runs for this agent submitted to the leaderboard. To submit multiple evaluations, rerun the same agent and set the same agent name</p>
                                </div>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Traces</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for row in leaderboard %}
                        <tr class="hover:bg-gray-50 {% if row.get('Is Pareto') %}bg-blue-50/40{% endif %}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm">{{ loop.index }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm">
                                    {% if row['URL'] %}
                                        <a href="{{ row['URL'] }}" target="_blank" class="text-blue-600 hover:text-blue-800">
                                            {{ row['Agent Name'] }}
                                            <svg class="inline-block w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                            </svg>
                                        </a>
                                    {% else %}
                                        <a href="{{ url_for('agent_page', agent_name=row['Agent Name']) }}" class="text-blue-600 hover:text-blue-800 font-medium">
                                            {{ row['Agent Name'] }}
                                        </a>
                                    {% endif %}
                                    {% if row.get('Is Pareto') %}
                                        <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Pareto optimal</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {% for model in row['Models'].split(',') %}
                                    <a href="{{ url_for('model_page', model_name=model.strip()) }}" class="inline-block text-blue-600 hover:text-blue-800 mr-2 py-0.5 rounded font-medium">{{ model.strip() }}</a>
                                {% endfor %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {% if row['Verified'] %}
                                    <span class="text-green-600">✓</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                    {{ "%.2f"|format(row['Accuracy']|float) }}%
                                    {% if row.get('Accuracy CI') and row['Accuracy CI'] != 'None' %}
                                        <span class="text-gray-500 ml-1">({{ row['Accuracy CI'] }})</span>
                                    {% endif %}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${{ "%.2f"|format(row['Total Cost']|float) }}
                                {% if row.get('Total Cost CI') and row['Total Cost CI'] != 'None' %}
                                    <span class="text-gray-400 text-xs">({{ row['Total Cost CI'] }})</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ row['Runs'] }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                {% if row.get('Traces') %}
                                    <a href="{{ row['Traces'] }}" target="_blank" class="text-blue-600 hover:text-blue-800">
                                        Download
                                        <svg class="inline-block w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                        </svg>
                                    </a>
                                {% else %}
                                    <span class="text-gray-400">N/A</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Visualization Section -->
        <div class="space-y-8 mb-12">
            <!-- Cost vs Accuracy Plot -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-3xl font-semibold mb-2">Accuracy vs. Cost Frontier for TAU-bench Airline</h3>
                        <p class="text-sm text-gray-500">
                            This plot shows the relationship between an agent's performance and its token cost.
                            The Pareto frontier (dashed line) represents the current state-of-the-art trade-off. The error bars indicate min-max values across runs.
                        </p>
                    </div>
                    {% if cutoff_applied %}
                    <button id="toggleCostRange" 
                            class="ml-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 text-sm">
                        Show Full Cost Range
                    </button>
                    {% endif %}
                </div>
                <div class="overflow-x-auto sm:overflow-x-visible">
                    <div id="costAccuracyPlot" class="w-[800px] sm:w-full h-[500px]"></div>
                </div>
            </div>

            <!-- Heatmap -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-3xl font-semibold mb-2">Heatmap for TAU-bench Airline</h3>
                <p class="text-sm text-gray-500 mb-4">
                    The heatmap visualizes success rates across tasks and agents. Colorscale shows the fraction of times a task was solved across reruns of the same agent. The "any agent" performance indicates the level of saturation of the benchmark and gives a sense of overall progress.
                </p>
                <div class="max-h-[500px] overflow-y-auto overscroll-contain">
                    <!-- Make plot taller than wrapper to enable inner scrolling -->
                    <div id="taskSuccessHeatmap" class="w-[800px] sm:w-full min-h-[1100px]"></div>
                </div>
            </div>

            <!-- Total Completion Tokens Used per Agent -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-3xl font-semibold mb-2">Total Completion Tokens Used per Agent</h3>
                <p class="text-sm text-gray-500 mb-4">
                    The bar chart shows the total completion tokens used by each agent, with the height of each bar representing the total number of completion tokens used across all tasks. 
                    Secondary models usually contribute a relatively small amount of tokens in comparison, and are used for RAG or image processing only.
                </p>
                <div class="max-h-[500px] overflow-y-auto overscroll-contain">
                    <div id="completionTokensBar" class="w-[800px] sm:w-full min-h-[1100px]"></div>
                </div>
            </div>
            
            <!-- Model Performance Timeline Chart -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-3xl font-semibold mb-2">Model Performance Over Time</h3>
                <p class="text-sm text-gray-500 mb-4">
                    Timeline showing model accuracy evolution over release dates. Each point represents the best performance achieved by that model on TAU-bench Airline.
                </p>
                <div class="overflow-x-auto sm:overflow-x-visible">
                    {% if timeline_chart %}
                        <div id="timeline-chart" class="w-full h-96"></div>
                    {% else %}
                        <div class="text-center py-8 text-gray-500">
                            <p>Timeline chart data not available</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Token Pricing Section -->
<div class="mx-auto max-w-[1500]px px-8 py-6">
    <div class="bg-white rounded-xl shadow-md p-8 mb-8">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-3xl font-semibold">Token Pricing Configuration</h3>
        </div>
        <p class="text-sm text-gray-500 mb-6">
            Adjust token prices to see how they affect the total cost calculations in the leaderboard and plots.
        </p>
        
        <form id="pricingForm">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                {% for model, prices in pricing.items() %}
                <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <h4 class="font-medium text-gray-900">{{ model }}</h4>
                            <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">Active</span>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Input Token Price</label>
                            <div class="mt-1 relative rounded-md shadow-sm">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 sm:text-sm">$</span>
                                </div>
                                <input type="number" 
                                       step="0.01" 
                                       min="0" 
                                       name="{{ model }}_prompt" 
                                       value="{{ prices.prompt_tokens }}"
                                       class="pl-7 block w-full rounded-md border-gray-300 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                       placeholder="0.00">
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <span class="text-gray-400 text-xs">/1M tokens</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Output Token Price</label>
                            <div class="mt-1 relative rounded-md shadow-sm">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 sm:text-sm">$</span>
                                </div>
                                <input type="number" 
                                       step="0.01" 
                                       min="0" 
                                       name="{{ model }}_completion" 
                                       value="{{ prices.completion_tokens }}"
                                       class="pl-7 block w-full rounded-md border-gray-300 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                       placeholder="0.00">
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <span class="text-gray-400 text-xs">/1M tokens</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="mt-8 flex items-center justify-between">
                <button type="button" 
                        id="updatePricing" 
                        class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" id="updateSpinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Update Results
                </button>
                <button type="button" 
                        id="resetPricing" 
                        class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Reset to Defaults
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Additional Resources -->
<div class="mx-auto max-w-[1500]px px-8 py-6 mb-16">
    <h2 class="text-3xl font-bold mb-8">Additional Resources</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="bg-white p-6 rounded-xl shadow-md">
            <h3 class="text-xl font-semibold mb-4">Getting Started</h3>
            <p class="text-gray-600 mb-4">
                Want to evaluate your agent on TAU-bench Airline? Follow our guide to get started:
            </p>
            <a href="https://github.com/princeton-pli/hal-harness/tree/main" class="text-blue-600 hover:text-blue-800 inline-flex items-center">
                View Documentation
                <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </a>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-md">
            <h3 class="text-xl font-semibold mb-4">Task Details</h3>
            <p class="text-gray-600 mb-4">
                Browse the complete TAU-bench Airline tasks:
            </p>
            <a href="https://github.com/sierra-research/tau-bench" class="text-blue-600 hover:text-blue-800 inline-flex items-center">
                View Tasks
                <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Parse the JSON data from Flask
    const scatter_plot_data = JSON.parse('{{ scatter_plot|safe }}');
    const heatmap_data = JSON.parse('{{ heatmap|safe }}');
    
    // Initialize plots with adjusted margins
    Plotly.newPlot('costAccuracyPlot', scatter_plot_data.data, {
        ...scatter_plot_data.layout,
        margin: { t: 10, r: 10, b: 40, l: 60 },
        width: window.innerWidth < 640 ? 800 : null,  // 640px is sm breakpoint
        height: 500
    }, {
        responsive: true,
        displayModeBar: false
    });
    
    Plotly.newPlot('taskSuccessHeatmap', heatmap_data.data, {
        ...heatmap_data.layout,
        margin: { t: 10, r: 10, b: 40, l: 60 },
        width: window.innerWidth < 640 ? 800 : null,  // 640px is sm breakpoint
        height: 500
    }, {
        responsive: true,
        displayModeBar: false
    });

    const completion_tokens_bar = JSON.parse('{{ completion_tokens_bar|safe }}');

    // Initialize completion tokens bar chart with consistent styling
    Plotly.newPlot('completionTokensBar', completion_tokens_bar.data, {
        ...completion_tokens_bar.layout,
        margin: { t: 10, r: 10, b: 40, l: 60 },
        width: null,  // Make plot responsive
        height: null  // Make plot responsive
    }, {
        responsive: true,
        displayModeBar: false
    });

    // Initialize timeline chart if data is available
    {% if timeline_chart %}
    const timeline_chart_data = JSON.parse('{{ timeline_chart|safe }}');
    Plotly.newPlot('timeline-chart', timeline_chart_data.data, {
        ...timeline_chart_data.layout,
        margin: { t: 10, r: 10, b: 40, l: 60 },
        width: null,  // Make plot responsive
        height: null  // Make plot responsive
    }, {
        responsive: true,
        displayModeBar: false
    });
    {% endif %}
    
    {% if cutoff_applied %}
    // Parse the full scatter plot data (only if cutoff was applied)
    const scatter_plot_full_data = JSON.parse('{{ scatter_plot_full|safe }}');
    
    // Handle cost range toggle
    let showingFullRange = false;
    const toggleButton = document.getElementById('toggleCostRange');
    
    toggleButton.addEventListener('click', function() {
        const currentData = showingFullRange ? scatter_plot_data : scatter_plot_full_data;
        const plotDiv = document.getElementById('costAccuracyPlot');
        
        Plotly.newPlot(plotDiv, currentData.data, {
            ...currentData.layout,
            margin: { t: 10, r: 10, b: 40, l: 60 },
            width: null,
            height: null
        }, {
            responsive: true,
            displayModeBar: false
        });
        
        showingFullRange = !showingFullRange;
        toggleButton.textContent = showingFullRange ? 'Show Cost Cutoff View' : 'Show Full Cost Range';
    });
    {% endif %}
    
    // Handle window resize
    window.addEventListener('resize', function() {
        const width = window.innerWidth < 640 ? 800 : null;
        Plotly.relayout('costAccuracyPlot', { width: width, height: 500 });
        Plotly.relayout('taskSuccessHeatmap', { width: width, height: 500 });
    });

    // Handle pricing update
    document.getElementById('updatePricing').addEventListener('click', async function() {
        const form = document.getElementById('pricingForm');
        const formData = new FormData(form);
        const spinner = document.getElementById('updateSpinner');
        
        // Convert form data to pricing configuration object
        const pricing = {};
        for (const [key, value] of formData.entries()) {
            const [model, type] = key.split('_');
            if (!pricing[model]) {
                pricing[model] = {};
            }
            pricing[model][type === 'prompt' ? 'prompt_tokens' : 'completion_tokens'] = parseFloat(value);
        }
        
        try {
            // Show loading state
            this.disabled = true;
            spinner.classList.remove('hidden');
            
            // Send pricing update request
            const response = await fetch('/update_pricing/{{ benchmark_name }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(pricing),
            });
            
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            
            const data = await response.json();
            
            // Update leaderboard
            const leaderboardBody = document.querySelector('tbody');
            leaderboardBody.innerHTML = data.leaderboard.map((row, index) => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm">
                            ${row['URL'] ? 
                                `<a href="${row['URL']}" target="_blank" class="text-blue-600 hover:text-blue-800">
                                    ${row['Agent Name']}
                                    <svg class="inline-block w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                    </svg>
                                </a>` 
                                : row['Agent Name']
                            }
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${row['Models'].split(',').map(model => 
                            `<span class="inline-block text-blue-600 mr-2 py-0.5 rounded">${model.trim()}</span>`
                        ).join('')}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${row['Verified'] ? '<span class="text-green-600">✓</span>' : ''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                            ${parseFloat(row['Accuracy']).toFixed(2)}%
                            ${row['Accuracy CI'] && row['Accuracy CI'] !== 'None' ? 
                                `<span class="text-gray-500 ml-1">(${row['Accuracy CI']})</span>` : 
                                ''
                            }
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        $${parseFloat(row['Total Cost']).toFixed(2)}
                        ${row['Total Cost CI'] && row['Total Cost CI'] !== 'None' ? 
                            `<span class="text-gray-400 text-xs">(${row['Total Cost CI']})</span>` : 
                            ''
                        }
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${row['Runs']}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        ${row['Traces'] ? 
                            `<a href="${row['Traces']}" target="_blank" class="text-blue-600 hover:text-blue-800">
                                Download
                                <svg class="inline-block w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                </svg>
                            </a>` : 
                            '<span class="text-gray-400">N/A</span>'
                        }
                    </td>
                </tr>
            `).join('');
            
            // Update scatter plot
            Plotly.react('costAccuracyPlot', data.scatter_plot.data, {
                ...data.scatter_plot.layout,
                margin: { t: 10, r: 10, b: 40, l: 60 },
                width: window.innerWidth < 640 ? 800 : null,
                height: 500
            }, {
                responsive: true,
                displayModeBar: false
            });
            
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to update pricing. Please try again.');
        } finally {
            // Reset button state
            this.disabled = false;
            spinner.classList.add('hidden');
        }
    });

    // Handle reset pricing
    document.getElementById('resetPricing').addEventListener('click', function() {
        const form = document.getElementById('pricingForm');
        const defaultPricing = JSON.parse('{{ pricing|tojson|safe }}');
        
        // Reset all input fields to their default values
        for (const [model, prices] of Object.entries(defaultPricing)) {
            const promptInput = form.querySelector(`input[name="${model}_prompt"]`);
            const completionInput = form.querySelector(`input[name="${model}_completion"]`);
            
            if (promptInput) promptInput.value = prices.prompt_tokens;
            if (completionInput) completionInput.value = prices.completion_tokens;
        }
        
        // Trigger the update
        document.getElementById('updatePricing').click();
    });
</script>
{% endblock %} 
